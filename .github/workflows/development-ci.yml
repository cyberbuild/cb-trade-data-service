name: Development CI & PR to Master

# Controls when the workflow will run
on:
  # Triggers the workflow on push events but only for the development branch
  push:
    branches:
      - development
  # Triggers the workflow on pull request events targeting the development branch
  pull_request:
    branches:
      - development

# Set default permissions for the GITHUB_TOKEN
# These permissions are necessary for the actions used in this workflow.
permissions:
  contents: write # Needed for peter-evans/create-pull-request to push a branch and create a PR
  packages: write # Needed to publish packages to GitHub Packages
  pull-requests: write # Needed to create pull requests

jobs:
  build-test-publish-and-pr:
    name: Build, Test, Publish & Create PR
    runs-on: ubuntu-latest # Specifies the type of runner the job will run on
    env: # Set environment variables for all steps in this job
      PYTHON DONTWRITEBYTECODE: '1' # Prevents Python from writing .pyc files

    steps:
      # 1. Checkout your repository code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetches all history for all branches and tags.
          fetch-depth: 0

      # 2. Set up Conda environment
      # This step should install all dependencies from environment.yml,
      # including conda packages and those listed under the 'pip:' section.
      # Ensure your environment.yml has 'name: cb-trade', 'python=3.9',
      # 'pip' as a conda dependency, and then ccxt, flake8, black, etc., under the 'pip:' section.
      - name: Set up Conda environment
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: cb-trade # Explicitly set to match environment.yml name
          environment-file: environment.yml # Path to your conda environment file
          python-version: '3.9' # Align with python=3.9 in environment.yml
          auto-activate-base: false # We want to activate the environment from the file
          use-mamba: true # Use Mamba for faster and potentially more robust dependency resolution

      # 3. Install/Verify build tools (if not already in environment.yml)
      # Best practice: include build, pytest, wheel in environment.yml dependencies (conda or pip section).
      # This step now primarily serves as a check or installs if truly missing.
      - name: Install package in editable mode and ensure tools
        # Ensures conda environment is activated for this step by using a login shell
        shell: bash -l {0}
        run: |
          echo "Verifying presence of build and test tools (build, wheel, pytest)."
          echo "These should be installed from environment.yml by the 'Set up Conda environment' step."
          python -m pip install build wheel
          echo "Installing the current package in editable mode..."
          python -m pip install -e .
          echo "Upgrading pydantic-settings..."
          python -m pip install --upgrade pydantic-settings

      # 4. (Optional but Recommended) Lint and Format Check
      # Flake8 and Black should be installed from environment.yml's pip section by Step 2.
      # Flake8 will use the .flake8 configuration file in the project root.
      - name: Lint and Format Check
        # Ensures conda environment is activated for this step by using a login shell
        shell: bash -l {0}
        run: |
          echo "Running linters and format checkers. Flake8 and Black should be installed via environment.yml."
          flake8 . --exclude tests # Exclude the tests folder from flake8
          black --check . --exclude tests # Optionally exclude tests from black as well

      # 5. Debug Environment Variables for Tests
      # This step helps verify if secrets and env vars are being set as expected.
      # It DOES NOT print the actual values of secrets for security.
      - name: Debug Environment Variables for Tests
        # Ensures conda environment is activated for this step by using a login shell
        shell: bash -l {0}
        env: # Pass the same env vars as the test step to check them
          STORAGE_AZURE_CONNECTION_STRING: ${{ secrets.STORAGE_AZURE_CONNECTION_STRING }}
          STORAGE__AZURE__CONTAINER_NAME: ${{ secrets.STORAGE_AZURE_CONTAINER_NAME }}
          CCXT_CRYPTO_COM_API_KEY: ${{ secrets.CCXT_CRYPTO_COM_API_KEY }}
          CCXT_CRYPTO_COM_SECRET: ${{ secrets.CCXT_CRYPTO_COM_SECRET }}
          STORAGE__TYPE: local
          STORAGE_LOCAL_ROOT_PATH: ./test_data
          CCXT_DEFAULT_EXCHANGE: cryptocom
        run: |
          echo "--- Debugging Environment Variables ---"
          echo "Checking for STORAGE_AZURE_CONNECTION_STRING..."
          if [ -n "$STORAGE_AZURE_CONNECTION_STRING" ]; then
            echo "STORAGE_AZURE_CONNECTION_STRING is SET (length: ${#STORAGE_AZURE_CONNECTION_STRING})"
          else
            echo "STORAGE_AZURE_CONNECTION_STRING is NOT SET"
          fi

          echo "Checking for STORAGE__AZURE__CONTAINER_NAME..."
          if [ -n "$STORAGE__AZURE__CONTAINER_NAME" ]; then
            echo "STORAGE__AZURE__CONTAINER_NAME is SET (value: $STORAGE__AZURE__CONTAINER_NAME)"
          else
            echo "STORAGE__AZURE__CONTAINER_NAME is NOT SET"
          fi

          echo "Checking for CCXT_CRYPTO_COM_API_KEY..."
          if [ -n "$CCXT_CRYPTO_COM_API_KEY" ]; then
            echo "CCXT_CRYPTO_COM_API_KEY is SET (length: ${#CCXT_CRYPTO_COM_API_KEY})"
          else
            echo "CCXT_CRYPTO_COM_API_KEY is NOT SET or empty"
          fi

          echo "Checking for CCXT_CRYPTO_COM_SECRET..."
          if [ -n "$CCXT_CRYPTO_COM_SECRET" ]; then
            echo "CCXT_CRYPTO_COM_SECRET is SET (length: ${#CCXT_CRYPTO_COM_SECRET})"
          else
            echo "CCXT_CRYPTO_COM_SECRET is NOT SET or empty"
          fi

          echo "STORAGE__TYPE is: $STORAGE__TYPE"
          echo "STORAGE_LOCAL_ROOT_PATH is: $STORAGE_LOCAL_ROOT_PATH"
          echo "CCXT_DEFAULT_EXCHANGE is: $CCXT_DEFAULT_EXCHANGE"
          echo "--- End Debugging Environment Variables ---"

      # 6. Run tests
      # Pytest should be installed from environment.yml (conda or pip section) by Step 2.
      # Environment variables for tests are passed via the 'env' context using GitHub secrets for sensitive data
      # and direct assignment for non-sensitive configurations.
      # --tb=long ensures full tracebacks are shown for all failures.
      - name: Run tests with Pytest
        # Ensures conda environment is activated for this step by using a login shell
        shell: bash -l {0}
        env:
          # Secrets (ensure these are created in GitHub Repository Settings > Secrets and variables > Actions)
          STORAGE_AZURE_CONNECTION_STRING: ${{ secrets.STORAGE_AZURE_CONNECTION_STRING }}
          STORAGE__AZURE__CONTAINER_NAME: ${{ secrets.STORAGE_AZURE_CONTAINER_NAME }}
          CCXT_CRYPTO_COM_API_KEY: ${{ secrets.CCXT_CRYPTO_COM_API_KEY }} # Only if your tests use this
          CCXT_CRYPTO_COM_SECRET: ${{ secrets.CCXT_CRYPTO_COM_SECRET }}   # Only if your tests use this

          # Non-sensitive configurations from your .env.test file
          STORAGE__TYPE: local
          STORAGE_LOCAL_ROOT_PATH: ./test_data # Relative path for local testing within the repo
          CCXT_DEFAULT_EXCHANGE: cryptocom
        run: pytest --tb=long

      # 7. Build package
      # The 'build' package should be installed (e.g., via environment.yml or Step 3).
      - name: Build package
        # Ensures conda environment is activated for this step by using a login shell
        shell: bash -l {0}
        run: python -m build

      # 8. Publish to GitHub Packages (only on direct push to development)
      - name: Publish package to GitHub Packages
        if: github.event_name == 'push' && github.ref == 'refs/heads/development'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.GITHUB_TOKEN }}
          repository_url: https://pypi.pkg.github.com/YOUR_USERNAME_OR_ORG/ # IMPORTANT: Replace with your GitHub username or organization

      # 9. Create Pull Request from development to master (only on direct push to development)
      - name: Create Pull Request to master
        if: github.event_name == 'push' && github.ref == 'refs/heads/development'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto-PR: Merge development into master after successful CI"
          branch: auto-pr/development-to-master
          base: master
          head: development
          title: 'Auto-PR: Merge `development` into `master`'
          body: |
            Automated Pull Request
            - This PR was automatically created after a successful build, test, and package publish on the `development` branch.
            - Please review the changes before merging.

            Triggered by commit: ${{ github.sha }}
          labels: automated pr, development-merge
          # assignees: your-github-username
          # reviewers: your-github-username,another-reviewer
          # draft: false
